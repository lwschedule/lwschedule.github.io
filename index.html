<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LW Schedule</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/images/logo.png">
  <link rel="apple-touch-icon" href="/images/logo.png">
  <style>
:root {
  --primary: #4b2e83;
  --primary-light: #6a4fb3;
  --text-light: #e8e8e8;
  --bg-dark: #1a1a1a;
  --card-dark: #262626;
  --glow: 0 0 12px rgba(107, 76, 183, 0.8);
}
body.theme-purple { --primary: #4b2e83; --primary-light: #6a4fb3; --glow: 0 0 12px rgba(107, 76, 183, 0.8); }
body.theme-red { --primary: #c41e3a; --primary-light: #e63946; --glow: 0 0 12px rgba(230, 57, 70, 0.8); }
body.theme-orange { --primary: #d35400; --primary-light: #e67e22; --glow: 0 0 12px rgba(230, 126, 34, 0.8); }
body.theme-yellow { --primary: #c29d00; --primary-light: #f1c40f; --glow: 0 0 12px rgba(241, 196, 15, 0.8); }
body.theme-green { --primary: #27ae60; --primary-light: #2ecc71; --glow: 0 0 12px rgba(46, 204, 113, 0.8); }
body.theme-blue { --primary: #2980b9; --primary-light: #3498db; --glow: 0 0 12px rgba(52, 152, 219, 0.8); }
body.theme-indigo { --primary: #3f51b5; --primary-light: #5c6bc0; --glow: 0 0 12px rgba(92, 107, 192, 0.8); }
body.theme-pink { --primary: #c2185b; --primary-light: #e91e63; --glow: 0 0 12px rgba(233, 30, 99, 0.8); }
* { font-family: 'Comfortaa', cursive; box-sizing: border-box; }
body { background: var(--bg-dark); color: var(--text-light); margin: 0; padding: 20px; scrollbar-width: none; -ms-overflow-style: none; transition: all 0.3s ease; padding-bottom: 100px; }
body::-webkit-scrollbar { display: none; }
body #digitalClock { background: linear-gradient(135deg, var(--primary), var(--primary-light), var(--primary)) !important; background-size: 200% 200% !important; animation: gradientShift 8s ease infinite !important; }
body #timer { color: white; background: linear-gradient(135deg, var(--primary), var(--primary-light), var(--primary)); background-size: 200% 200%; animation: gradientShift 8s ease infinite; }
body .mainBtn:not(.disabledBtn) { background: linear-gradient(135deg, var(--primary), var(--primary-light), var(--primary)) !important; background-size: 200% 200% !important; animation: gradientShift2 8s ease infinite !important; }
body .circleBtn { background: linear-gradient(135deg, var(--primary), var(--primary-light), var(--primary)) !important; background-size: 200% 200% !important; animation: gradientShift3 8s ease infinite !important; }
body .backBtn { background: linear-gradient(135deg, var(--primary), var(--primary-light), var(--primary)) !important; background-size: 200% 200% !important; animation: gradientShift3 8s ease infinite !important; }
body h2, body h3 { color: white; }
@keyframes gradientShift { 0% { background-position: 0% 50%; } 25% { background-position: 100% 25%; } 50% { background-position: 0% 75%; } 75% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
@keyframes gradientShift2 { 0% { background-position: 100% 0%; } 33% { background-position: 0% 100%; } 66% { background-position: 50% 50%; } 100% { background-position: 100% 0%; } }
@keyframes gradientShift3 { 0% { background-position: 50% 100%; } 30% { background-position: 100% 0%; } 60% { background-position: 0% 50%; } 100% { background-position: 50% 100%; } }
@keyframes rollUpIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes rollUpOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
.digit-roller { display: inline-block; position: relative; overflow: hidden; line-height: 1em; height: 1em; vertical-align: middle; }
.digit-roller span { display: inline-block; position: absolute; left: 0; right: 0; text-align: center; }
.digit-roller .old { animation: rollUpOut 0.4s ease-out forwards; }
.digit-roller .new { transform: translateY(100%); animation: rollUpIn 0.4s ease-out forwards; }
.static-char { display: inline-block; vertical-align: middle; }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
h1, h2, h3 { animation: fadeInUp 0.6s ease-out; text-align: center; }
.topRightButtons { position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 1000; }
.circleBtn { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-light); color: white; border: none; font-size: 1.5em; cursor: pointer; box-shadow: var(--glow); transition: all 0.3s; display: flex; align-items: center; justify-content: center; text-decoration: none; font-weight: 700; }
.circleBtn:hover { transform: scale(1.1); }
#digitalClock { font-weight: 700; text-align: center; color: white; background: var(--primary-light); padding: 20px; border-radius: 16px; box-shadow: var(--glow); max-width: 650px; margin: 20px auto; }
#clockLabel { font-size: 0.8em; margin-bottom: 10px; color: white; opacity: 0.9; font-weight: 700; }
#clockDisplay { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 15px; margin-top: 15px; }
.time-block { background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 15px 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.time-value { font-size: clamp(1.8em, 6vw, 2.8em); font-weight: 700; color: white; line-height: 1.1; text-align: center; position: relative; overflow: hidden; }
.time-label { font-size: 0.7em; font-weight: 400; color: white; opacity: 0.8; letter-spacing: 0.1em; text-transform: uppercase; margin-top: 5px; }
#timer { font-size: clamp(0.9em, 4vw, 1.1em); margin-top: 20px; text-align: center; background: var(--card-dark); padding: 15px; border-radius: 16px; box-shadow: var(--glow); color: var(--text-light); max-width: 650px; margin: 20px auto; }
#timer.hidden { display: none; }
.mainButtons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; justify-content: center; max-width: 650px; margin: 30px auto; }
.mainBtn { background: var(--primary-light); color: white; border: none; padding: 15px 30px; font-size: 1.1em; border-radius: 12px; cursor: pointer; box-shadow: var(--glow); transition: all 0.3s; font-weight: 700; text-decoration: none; text-align: center; display: block; }
.mainBtn:hover { transform: scale(1.05); }
@media (max-width: 600px) {
  .mainButtons { grid-template-columns: 1fr; }
  .topRightButtons { top: 10px; right: 10px; }
  .circleBtn { width: 45px; height: 45px; font-size: 1.3em; }
  #clockDisplay { grid-template-columns: repeat(2, 1fr); }
}
  </style>
</head>
<body>
  <div class="topRightButtons">
    <a href="/info" class="circleBtn" aria-label="About">i</a>
    <a href="/settings" class="circleBtn" aria-label="Settings">⚙️</a>
  </div>
  <h1>LW Schedule</h1>
  <div id="digitalClock">
    <div id="clockLabel">TIME REMAINING</div>
    <div id="clockDisplay">--:--:--</div>
  </div>
  <div id="timer"></div>
  <div class="mainButtons">
    <a class="mainBtn" href="/today">Today</a>
    <a class="mainBtn" href="/week">Week</a>
    <a class="mainBtn" href="/month">Month</a>
    <a class="mainBtn" href="/schedules">All Schedules</a>
    <a class="mainBtn" href="/holidays">Upcoming Holidays</a>
    <a class="mainBtn" href="/quarters">Quarters/Semesters</a>
  </div>
  <script>
let lunchPreferences = {
  Monday: 'A',
  Tuesday: 'A',
  Wednesday: 'All',
  Thursday: 'A',
  Friday: 'A'
};
let currentHolidayMessage = null;
let quartersInterval = null;

const holidays = [
  { name: "Labor Day", date: new Date(2025, 8, 1), displayDate: "September 1, 2025", isWeekend: false },
  { name: "LEAP Day", date: new Date(2025, 9, 17), displayDate: "October 17, 2025", isWeekend: false },
  { name: "LEAP Day", date: new Date(2025, 10, 4), displayDate: "November 4, 2025", isWeekend: false },
  { name: "Veterans Day", date: new Date(2025, 10, 11), displayDate: "November 11, 2025", isWeekend: false },
  { name: "Thanksgiving Break", date: new Date(2025, 10, 27), displayDate: "November 27-29, 2025", isWeekend: true },
  { name: "Winter Break", date: new Date(2025, 11, 20), displayDate: "December 20, 2025 - January 4, 2026", isWeekend: true },
  { name: "MLK Jr. Day", date: new Date(2026, 0, 19), displayDate: "January 19, 2026", isWeekend: true },
  { name: "Mid-Winter Break", date: new Date(2026, 1, 12), displayDate: "February 12-16, 2026", isWeekend: true },
  { name: "Presidents Day", date: new Date(2026, 1, 16), displayDate: "February 16, 2026", isWeekend: true },
  { name: "LEAP Day", date: new Date(2026, 2, 13), displayDate: "March 13, 2026", isWeekend: false },
  { name: "Spring Break", date: new Date(2026, 3, 13), displayDate: "April 13-17, 2026", isWeekend: true },
  { name: "LEAP Day", date: new Date(2026, 4, 22), displayDate: "May 22, 2026", isWeekend: false },
  { name: "Memorial Day", date: new Date(2026, 4, 25), displayDate: "May 25, 2026", isWeekend: true },
  { name: "Last Day of School", date: new Date(2026, 5, 17), displayDate: "June 17, 2026", isWeekend: false }
];

const academicTerms = {
  quarters: [
    { name: "1st Quarter", start: new Date(2025, 8, 2, 0, 0, 0), end: new Date(2025, 10, 4, 23, 59, 59) },
    { name: "2nd Quarter", start: new Date(2025, 10, 5, 0, 0, 0), end: new Date(2026, 0, 23, 23, 59, 59) },
    { name: "3rd Quarter", start: new Date(2026, 0, 24, 0, 0, 0), end: new Date(2026, 3, 3, 23, 59, 59) },
    { name: "4th Quarter", start: new Date(2026, 3, 4, 0, 0, 0), end: new Date(2026, 5, 17, 23, 59, 59) }
  ],
  semesters: [
    { name: "1st Semester", start: new Date(2025, 8, 2, 0, 0, 0), end: new Date(2026, 0, 23, 23, 59, 59) },
    { name: "2nd Semester", start: new Date(2026, 0, 24, 0, 0, 0), end: new Date(2026, 5, 17, 23, 59, 59) }
  ]
};

function checkSetupComplete() {
  const theme = localStorage.getItem('theme');
  const gradient = localStorage.getItem('gradient');
  const lunch = localStorage.getItem('lunchPreferences');
  const packup = localStorage.getItem('pack-up-time');
  const setupComplete = localStorage.getItem('setup-complete');
  
  if (!setupComplete && !window.location.pathname.includes('/setup')) {
    if (!theme || !gradient || !lunch || packup === null) {
      window.location.href = '/setup';
      return false;
    }
  }
  return true;
}

function loadLunchPreferences() {
  try {
    const saved = localStorage.getItem('lunchPreferences');
    if (saved) lunchPreferences = JSON.parse(saved);
  } catch (e) {}
}

function updateRollingText(element, newText) {
  if (!element) return;
  let oldText = element.dataset.previousText;
  if (!oldText) {
    if (element.querySelector('.digit-roller .new')) {
      oldText = element.querySelector('.digit-roller .new').textContent;
    } else {
      oldText = element.textContent;
    }
  }
  if (oldText === newText) return;
  const isNumeric = /^\d+$/.test(newText) && /^\d+$/.test(oldText);
  if (oldText === "--") {
    element.textContent = newText;
    element.dataset.previousText = newText;
    return;
  }
  if (isNumeric && oldText !== newText) {
    element.dataset.previousText = newText;
    const maxWidth = Math.max(oldText.length, newText.length) * 0.6;
    element.innerHTML = `<span class="digit-roller" style="width: ${maxWidth}em; height: 1em; line-height: 1em;"><span class="old">${oldText}</span><span class="new">${newText}</span></span>`;
    return;
  }
  if (!isNumeric && oldText && oldText.length !== newText.length) {
    element.textContent = newText;
    element.dataset.previousText = newText;
    return;
  }
  if (newText && !newText.match(/^[\d: -]+$/) && !newText.match(/d|h|m|s/)) {
    if (oldText !== newText) element.textContent = newText;
    element.dataset.previousText = newText;
    return;
  }
  element.dataset.previousText = newText;
  let html = '';
  let newChars = newText.split('');
  let oldChars = oldText.split('');
  let len = Math.max(newChars.length, oldChars.length);
  for (let i = 0; i < len; i++) {
    let newChar = newChars[i] || '';
    let oldChar = oldChars[i] || '';
    if (newChar === oldChar) {
      html += `<span class="static-char">${newChar}</span>`;
    } else {
      let width = '0.6em';
      if (newChar === ':' || newChar === '.') width = '0.3em';
      if (newChar === ' ') width = '0.2em';
      if (['d', 'h', 'm', 's'].includes(newChar)) width = '0.5em';
      html += `<span class="digit-roller" style="width: ${width}; height: 1em; line-height: 1em;">`;
      html += `<span class="old">${oldChar}</span>`;
      html += `<span class="new">${newChar}</span>`;
      html += `</span>`;
    }
  }
  element.innerHTML = html;
}

function isFinalsWeek(date) {
  const year = date.getFullYear();
  const month = date.getMonth();
  const day = date.getDate();
  return year === 2026 && month === 0 && day >= 19 && day <= 23;
}

function getSchedules(date) {
  const today = getDayNameFromDate(date);
  const lunch = lunchPreferences[today] || 'A';
  
  if (isFinalsWeek(date)) {
    return {
      Monday: [],
      Tuesday: [
        { name:"Period 1", start: 8*60+35, end: 9*60+20 },
        { name:"Period 2", start: 9*60+30, end: 10*60+50 },
        ...(lunch === 'A' ? [
          { name:"A Lunch", start: 10*60+50, end: 11*60+20 },
          { name:"Period 4", start: 11*60+30, end: 12*60+50 }
        ] : [
          { name:"Period 4", start: 11*60, end: 12*60+20 },
          { name:"B Lunch", start: 12*60+20, end: 12*60+50 }
        ]),
        { name:"Period 4", start: 13*60, end: 13*60+45 },
        { name:"Period 6", start: 13*60+55, end: 15*60+15 }
      ],
      Wednesday: [
        { name:"Period 1", start: 8*60+35, end: 9*60+55 },
        { name:"Period 3", start: 10*60+5, end: 11*60+25 },
        { name:"Period 5", start: 11*60+35, end: 12*60+55 },
        { name:"Lunch", start: 13*60, end: 13*60+30 }
      ],
      Thursday: [
        { name:"Period 2", start: 8*60+35, end: 9*60+55 },
        { name:"Period 3", start: 10*60+5, end: 10*60+50 },
        ...(lunch === 'A' ? [
          { name:"A Lunch", start: 10*60+50, end: 11*60+20 },
          { name:"Period 4", start: 11*60+30, end: 12*60+50 }
        ] : [
          { name:"Period 4", start: 11*60, end: 12*60+20 },
          { name:"B Lunch", start: 12*60+20, end: 12*60+50 }
        ]),
        { name:"Period 5", start: 13*60, end: 13*60+45 },
        { name:"Period 6", start: 13*60+55, end: 15*60+15 }
      ],
      Friday: [
        { name:"Period 1", start: 8*60+35, end: 9*60+55 },
        { name:"Period 2", start: 10*60+5, end: 10*60+50 },
        ...(lunch === 'A' ? [
          { name:"A Lunch", start: 10*60+50, end: 11*60+20 },
          { name:"Period 3", start: 11*60+30, end: 12*60+50 }
        ] : [
          { name:"Period 3", start: 11*60, end: 12*60+20 },
          { name:"B Lunch", start: 12*60+20, end: 12*60+50 }
        ]),
        { name:"Period 5", start: 13*60, end: 14*60+20 },
        { name:"Period 6", start: 14*60+30, end: 15*60+15 }
      ]
    };
  }
  
  return {
    Monday: [
      { name:"Period 1", start: 8*60+35, end: 9*60+55 },
      { name:"Period 2", start: 10*60+5, end: 10*60+50 },
      ...(lunch === 'A' ? [
        { name:"A Lunch", start: 10*60+50, end: 11*60+20 },
        { name:"Period 3", start: 11*60+30, end: 12*60+50 }
      ] : [
        { name:"Period 3", start: 11*60, end: 12*60+20 },
        { name:"B Lunch", start: 12*60+20, end: 12*60+50 }
      ]),
      { name:"Period 5", start: 13*60, end: 14*60+20 },
      { name:"Period 6", start: 14*60+30, end: 15*60+15 }
    ],
    Tuesday: [
      { name:"Period 1", start: 8*60+35, end: 9*60+20 },
      { name:"Period 2", start: 9*60+30, end: 10*60+50 },
      ...(lunch === 'A' ? [
        { name:"A Lunch", start: 10*60+50, end: 11*60+20 },
        { name:"Period 4 (Part 1)", start: 11*60+30, end: 12*60+50 }
      ] : [
        { name:"Period 4 (Part 1)", start: 11*60, end: 12*60+20 },
        { name:"B Lunch", start: 12*60+20, end: 12*60+50 }
      ]),
      { name:"Break", start: 12*60+50, end: 13*60 },
      { name:"Period 4 (Part 2)", start: 13*60, end: 13*60+45 },
      { name:"Period 6", start: 13*60+55, end: 15*60+15 }
    ],
    Wednesday: [
      { name:"Period 1", start: 8*60+35, end: 9*60+55 },
      { name:"Period 3", start: 10*60+5, end: 11*60+25 },
      { name:"Period 5", start: 11*60+35, end: 12*60+55 },
      { name:"Lunch", start: 13*60, end: 13*60+30 }
    ],
    Thursday: [
      { name:"Period 2", start: 8*60+35, end: 9*60+55 },
      { name:"Period 3", start: 10*60+5, end: 10*60+50 },
      ...(lunch === 'A' ? [
        { name:"A Lunch", start: 10*60+50, end: 11*60+20 },
        { name:"Period 4", start: 11*60+30, end: 12*60+50 }
      ] : [
        { name:"Period 4", start: 11*60, end: 12*60+20 },
        { name:"B Lunch", start: 12*60+20, end: 12*60+50 }
      ]),
      { name:"Period 5", start: 13*60, end: 13*60+45 },
      { name:"Period 6", start: 13*60+55, end: 15*60+15 }
    ],
    Friday: [
      { name:"Period 1", start: 8*60+35, end: 9*60+23 },
      { name:"Homeroom", start: 9*60+30, end: 10*60+10 },
      { name:"Period 2", start: 10*60+17, end: 11*60+5 },
      ...(lunch === 'A' ? [
        { name:"A Lunch", start: 11*60+5, end: 11*60+35 },
        { name:"Period 3", start: 11*60+42, end: 12*60+30 }
      ] : [
        { name:"Period 3", start: 11*60+12, end: 12*60 },
        { name:"B Lunch", start: 12*60, end: 12*60+30 }
      ]),
      { name:"Period 4", start: 12*60+37, end: 13*60+25 },
      { name:"Period 5", start: 13*60+32, end: 14*60+20 },
      { name:"Period 6", start: 14*60+27, end: 15*60+15 }
    ]
  };
}

function getDayNameFromDate(date) {
  return date.toLocaleDateString('en-US', { weekday: 'long' });
}

function currentDayName() {
  return getDayNameFromDate(new Date());
}

function minutesNow() {
  const d = new Date();
  return d.getHours()*60 + d.getMinutes();
}

function secondsNow() {
  return new Date().getSeconds();
}

function format(m) {
  let h = Math.floor(m/60);
  const mm = m%60;
  const ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12;
  h = h ? h : 12;
  return `${h}:${mm.toString().padStart(2,'0')} ${ampm}`;
}

function formatDuration(minutes) {
  if (minutes < 60) return `${minutes} min`;
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return m > 0 ? `${h}h ${m}m` : `${h}h`;
}

function displayTimeBlocks(container, data) {
  const daysId = container.id ? container.id.replace('Display', '') + '-days' : '';
  const hoursId = container.id ? container.id.replace('Display', '') + '-hours' : '';
  const minutesId = container.id ? container.id.replace('Display', '') + '-minutes' : '';
  const secondsId = container.id ? container.id.replace('Display', '') + '-seconds' : '';
  
  const existingDays = document.getElementById(daysId);
  const existingHours = document.getElementById(hoursId);
  const existingMinutes = document.getElementById(minutesId);
  const existingSeconds = document.getElementById(secondsId);
  
  function getPreviousValue(elem, fallback) {
    if (!elem) return fallback;
    if (elem.dataset.previousText) return elem.dataset.previousText;
    if (elem.querySelector('.digit-roller')) {
      const newSpan = elem.querySelector('.new');
      return newSpan ? newSpan.textContent : fallback;
    }
    return elem.textContent || fallback;
  }
  
  const prevDays = getPreviousValue(existingDays, '');
  const prevHours = getPreviousValue(existingHours, '');
  const prevMinutes = getPreviousValue(existingMinutes, '');
  const prevSeconds = getPreviousValue(existingSeconds, '');
  
  let html = '';
  if (data.days !== undefined) {
    const daysVal = data.days.toString();
    html += `<div class="time-block"><span id="${daysId}" class="time-value" data-previous-text="${prevDays || daysVal}">${daysVal}</span><span class="time-label">${data.days === 1 ? 'DAY' : 'DAYS'}</span></div>`;
  }
  if (data.hours !== undefined) {
    const hoursVal = data.hours.toString().padStart(2, '0');
    html += `<div class="time-block"><span id="${hoursId}" class="time-value" data-previous-text="${prevHours || hoursVal}">${hoursVal}</span><span class="time-label">${data.hours === 1 ? 'HOUR' : 'HOURS'}</span></div>`;
  }
  const minutesVal = data.minutes.toString().padStart(2, '0');
  const secondsVal = data.seconds.toString().padStart(2, '0');
  html += `<div class="time-block"><span id="${minutesId}" class="time-value" data-previous-text="${prevMinutes || minutesVal}">${minutesVal}</span><span class="time-label">MINUTES</span></div>`;
  html += `<div class="time-block"><span id="${secondsId}" class="time-value" data-previous-text="${prevSeconds || secondsVal}">${secondsVal}</span><span class="time-label">SECONDS</span></div>`;
  container.innerHTML = html;
}

function displayMessage(container, message) {
  container.innerHTML = `<div class="time-block" style="grid-column: 1/-1;"><span class="time-value" style="font-size: 1.5em;">${message}</span></div>`;
}

function getNextSchoolDayStartTime() {
  let nextDay = new Date();
  nextDay.setDate(nextDay.getDate() + 1);
  nextDay.setHours(0, 0, 0, 0);
  for (let i = 0; i < 365; i++) {
    const dayName = getDayNameFromDate(nextDay);
    const holiday = getHolidayForDate(nextDay);
    if (dayName !== 'Saturday' && dayName !== 'Sunday' && !holiday) {
      const schedules = getSchedules(nextDay);
      const schedule = schedules[dayName];
      if (schedule && schedule.length > 0) {
        const firstPeriod = schedule[0];
        const startTime = new Date(nextDay);
        startTime.setMinutes(firstPeriod.start);
        return startTime;
      }
    }
    nextDay.setDate(nextDay.getDate() + 1);
  }
  return null;
}

function getLastSchoolDayEndTime(beforeDate) {
  let checkDay = new Date(beforeDate.getFullYear(), beforeDate.getMonth(), beforeDate.getDate());
  checkDay.setDate(checkDay.getDate() - 1);
  checkDay.setHours(23, 59, 59, 999);
  for (let i = 0; i < 365; i++) {
    const dayName = getDayNameFromDate(checkDay);
    const holiday = getHolidayForDate(checkDay);
    if (dayName !== 'Saturday' && dayName !== 'Sunday' && !holiday) {
      const schedules = getSchedules(checkDay);
      const schedule = schedules[dayName];
      if (schedule && schedule.length > 0) {
        const lastPeriod = schedule[schedule.length - 1];
        const endTime = new Date(checkDay);
        endTime.setHours(0, 0, 0, 0);
        endTime.setMinutes(lastPeriod.end);
        return endTime;
      }
    }
    checkDay.setDate(checkDay.getDate() - 1);
  }
  return null;
}

function getHolidayForDate(date) {
  const checkTime = new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
  for (const holiday of holidays) {
    const holidayTime = new Date(holiday.date.getFullYear(), holiday.date.getMonth(), holiday.date.getDate()).getTime();
    if (checkTime === holidayTime) return holiday.name;
    if (holiday.name === "Thanksgiving Break") {
      const start = new Date(2025, 10, 27).getTime();
      const end = new Date(2025, 10, 29).getTime();
      if (checkTime >= start && checkTime <= end) return holiday.name;
    }
    if (holiday.name === "Winter Break") {
      const start = new Date(2025, 11, 20).getTime();
      const end = new Date(2026, 0, 4).getTime();
      if (checkTime >= start && checkTime <= end) return holiday.name;
    }
    if (holiday.name === "Mid-Winter Break") {
      const start = new Date(2026, 1, 12).getTime();
      const end = new Date(2026, 1, 16).getTime();
      if (checkTime >= start && checkTime <= end) return holiday.name;
    }
    if (holiday.name === "Spring Break") {
      const start = new Date(2026, 3, 13).getTime();
      const end = new Date(2026, 3, 17).getTime();
      if (checkTime >= start && checkTime <= end) return holiday.name;
    }
  }
  return null;
}

function getNextPeriodStart(schedule, now) {
  for (let i = 0; i < schedule.length; i++) {
    if (now < schedule[i].start) {
      return schedule[i];
    }
  }
  return null;
}

function updateClock() {
  const clockDisplay = document.getElementById('clockDisplay');
  const clockLabel = document.getElementById('clockLabel');
  const timerEl = document.getElementById('timer');
  if (!clockDisplay || !clockLabel || !timerEl) return;
  const schedules = getSchedules(new Date());
  const today = schedules[currentDayName()];
  if (!today || today.length === 0) {
    const nextSchoolStartTime = getNextSchoolDayStartTime();
    if (nextSchoolStartTime) {
      const nowMillis = new Date().getTime();
      const diff = nextSchoolStartTime.getTime() - nowMillis;
      if (diff > 0) {
        const totalSeconds = Math.floor(diff / 1000);
        const s = totalSeconds % 60;
        const totalMinutes = Math.floor(totalSeconds / 60);
        const m = totalMinutes % 60;
        const totalHours = Math.floor(totalMinutes / 60);
        const h = totalHours % 24;
        const d = Math.floor(totalHours / 24);
        const needsDays = d > 0;
        const needsHours = h > 0 || needsDays;
        const daysEl = document.getElementById('clockDisplay-days');
        const hoursEl = document.getElementById('clockDisplay-hours');
        const hasDays = daysEl !== null;
        const hasHours = hoursEl !== null;
        const needsStructureChange = clockDisplay.children.length === 0 || 
          (needsDays && !hasDays) || 
          (!needsDays && hasDays) || 
          (needsHours && !hasHours && !needsDays) || 
          (!needsHours && hasHours && !needsDays);
        if (needsStructureChange) {
          if (d > 0) {
            displayTimeBlocks(clockDisplay, { days: d, hours: h, minutes: m, seconds: s });
          } else if (h > 0) {
            displayTimeBlocks(clockDisplay, { hours: h, minutes: m, seconds: s });
          } else {
            displayTimeBlocks(clockDisplay, { minutes: m, seconds: s });
          }
        }
        // Always get fresh references after potential rebuild
        const daysElAfter = document.getElementById('clockDisplay-days');
        const hoursElAfter = document.getElementById('clockDisplay-hours');
        const minutesElAfter = document.getElementById('clockDisplay-minutes');
        const secondsElAfter = document.getElementById('clockDisplay-seconds');
        if (daysElAfter) updateRollingText(daysElAfter, d.toString());
        if (hoursElAfter) updateRollingText(hoursElAfter, h.toString().padStart(2,'0'));
        if (minutesElAfter) updateRollingText(minutesElAfter, m.toString().padStart(2,'0'));
        if (secondsElAfter) updateRollingText(secondsElAfter, s.toString().padStart(2,'0'));
        clockLabel.innerHTML = "UNTIL NEXT SCHOOL DAY";
        timerEl.innerHTML = `Next school day: ${nextSchoolStartTime.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}`;
        timerEl.classList.remove('hidden');
      } else {
        displayMessage(clockDisplay, "See You Soon!");
        clockLabel.innerHTML = "SCHOOL IS OVER";
        timerEl.innerHTML = "See you at the next school day!";
        timerEl.classList.remove('hidden');
      }
    } else {
      displayMessage(clockDisplay, "Enjoy Your Break!");
      clockLabel.innerHTML = "SCHOOL'S OUT";
      timerEl.innerHTML = "Have a great break!";
      timerEl.classList.remove('hidden');
    }
    return;
  }
  const now = minutesNow();
  const secs = secondsNow();
  let current = null;
  let next = null;
  for (let i = 0; i < today.length; i++) {
    const p = today[i];
    if (now >= p.start && now < p.end) {
      current = p;
      next = today[i+1] || null;
      break;
    }
  }
  if (!current) {
    for (let i = 0; i < today.length-1; i++) {
      if (now >= today[i].end && now < today[i+1].start) {
        current = { name: "Passing Period", start: today[i].end, end: today[i+1].start };
        next = today[i+1];
        break;
      }
    }
  }
  if (current) {
    const remainingMinutes = current.end - now - 1;
    const remainingSeconds = 60 - secs;
    const h = Math.floor(remainingMinutes / 60);
    const m = remainingMinutes % 60;
    const s = remainingSeconds === 60 ? 0 : remainingSeconds;
    const needsHours = h > 0;
    const hoursEl = document.getElementById('clockDisplay-hours');
    const hasHours = hoursEl !== null;
    const needsStructureChange = clockDisplay.children.length === 0 || (needsHours && !hasHours) || (!needsHours && hasHours);
    if (needsStructureChange) {
      if (h > 0) {
        displayTimeBlocks(clockDisplay, { hours: h, minutes: m, seconds: s });
      } else {
        displayTimeBlocks(clockDisplay, { minutes: m, seconds: s });
      }
    }
    // Always get fresh references after potential rebuild
    const hoursElAfter = document.getElementById('clockDisplay-hours');
    const minutesElAfter = document.getElementById('clockDisplay-minutes');
    const secondsElAfter = document.getElementById('clockDisplay-seconds');
    if (hoursElAfter) updateRollingText(hoursElAfter, h.toString().padStart(2,'0'));
    if (minutesElAfter) updateRollingText(minutesElAfter, m.toString().padStart(2,'0'));
    if (secondsElAfter) updateRollingText(secondsElAfter, s.toString().padStart(2,'0'));
    clockLabel.innerHTML = `TIME REMAINING - ${current.name}`;
    const nextName = next ? `${next.name}<br>${format(next.start)} - ${format(next.end)}` : "School Day Complete";
    timerEl.innerHTML = `Current: <b>${current.name}</b><br>Next: ${nextName}`;
    timerEl.classList.remove('hidden');
    } else {
      const firstPeriod = today[0];
      const lastPeriod = today[today.length - 1];
      if (now < firstPeriod.start) {
        const remainingMinutes = firstPeriod.start - now - 1;
        const remainingSeconds = 60 - secs;
        const h = Math.floor(remainingMinutes / 60);
        const m = remainingMinutes % 60;
        const s = remainingSeconds === 60 ? 0 : remainingSeconds;
        const needsHours = h > 0;
        const hoursEl = document.getElementById('clockDisplay-hours');
        const hasHours = hoursEl !== null;
        const needsStructureChange = clockDisplay.children.length === 0 || (needsHours && !hasHours) || (!needsHours && hasHours);
        if (needsStructureChange) {
          if (h > 0) {
            displayTimeBlocks(clockDisplay, { hours: h, minutes: m, seconds: s });
          } else {
            displayTimeBlocks(clockDisplay, { minutes: m, seconds: s });
          }
        }
        // Always get fresh references after potential rebuild
        const hoursElAfter = document.getElementById('clockDisplay-hours');
        const minutesElAfter = document.getElementById('clockDisplay-minutes');
        const secondsElAfter = document.getElementById('clockDisplay-seconds');
        if (hoursElAfter) updateRollingText(hoursElAfter, h.toString().padStart(2,'0'));
        if (minutesElAfter) updateRollingText(minutesElAfter, m.toString().padStart(2,'0'));
        if (secondsElAfter) updateRollingText(secondsElAfter, s.toString().padStart(2,'0'));
      clockLabel.innerHTML = "UNTIL SCHOOL STARTS";
      timerEl.innerHTML = `Next: <b>${firstPeriod.name}</b><br>${format(firstPeriod.start)} - ${format(firstPeriod.end)}`;
      timerEl.classList.remove('hidden');
    } else if (now >= lastPeriod.end) {
      const nextSchoolStartTime = getNextSchoolDayStartTime();
      if (nextSchoolStartTime) {
        const nowMillis = new Date().getTime();
        const diff = nextSchoolStartTime.getTime() - nowMillis;
        if (diff > 0) {
          const totalSeconds = Math.floor(diff / 1000);
          const s = totalSeconds % 60;
          const totalMinutes = Math.floor(totalSeconds / 60);
          const m = totalMinutes % 60;
          const totalHours = Math.floor(totalMinutes / 60);
          const h = totalHours % 24;
          const d = Math.floor(totalHours / 24);
          const needsDays = d > 0;
          const needsHours = h > 0 || needsDays;
          const daysEl = document.getElementById('clockDisplay-days');
          const hoursEl = document.getElementById('clockDisplay-hours');
          const hasDays = daysEl !== null;
          const hasHours = hoursEl !== null;
          const needsStructureChange = clockDisplay.children.length === 0 || 
            (needsDays && !hasDays) || 
            (!needsDays && hasDays) || 
            (needsHours && !hasHours && !needsDays) || 
            (!needsHours && hasHours && !needsDays);
          if (needsStructureChange) {
            if (d > 0) {
              displayTimeBlocks(clockDisplay, { days: d, hours: h, minutes: m, seconds: s });
            } else if (h > 0) {
              displayTimeBlocks(clockDisplay, { hours: h, minutes: m, seconds: s });
            } else {
              displayTimeBlocks(clockDisplay, { minutes: m, seconds: s });
            }
          }
          // Always get fresh references after potential rebuild
          const daysElAfter = document.getElementById('clockDisplay-days');
          const hoursElAfter = document.getElementById('clockDisplay-hours');
          const minutesElAfter = document.getElementById('clockDisplay-minutes');
          const secondsElAfter = document.getElementById('clockDisplay-seconds');
          if (daysElAfter) updateRollingText(daysElAfter, d.toString());
          if (hoursElAfter) updateRollingText(hoursElAfter, h.toString().padStart(2,'0'));
          if (minutesElAfter) updateRollingText(minutesElAfter, m.toString().padStart(2,'0'));
          if (secondsElAfter) updateRollingText(secondsElAfter, s.toString().padStart(2,'0'));
          clockLabel.innerHTML = "UNTIL NEXT SCHOOL DAY";
          timerEl.innerHTML = `Next school day: ${nextSchoolStartTime.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}`;
          timerEl.classList.remove('hidden');
        } else {
          displayMessage(clockDisplay, "See You Soon!");
          clockLabel.innerHTML = "SCHOOL IS OVER";
          timerEl.innerHTML = "See you tomorrow!";
          timerEl.classList.remove('hidden');
        }
      } else {
        displayMessage(clockDisplay, "Enjoy Your Break!");
        clockLabel.innerHTML = "SCHOOL'S OUT";
        timerEl.innerHTML = "Have a great break!";
        timerEl.classList.remove('hidden');
      }
      } else {
        const nextPeriod = getNextPeriodStart(today, now);
        if (nextPeriod) {
          const remainingMinutes = nextPeriod.start - now - 1;
          const remainingSeconds = 60 - secs;
          const h = Math.floor(remainingMinutes / 60);
          const m = remainingMinutes % 60;
          const s = remainingSeconds === 60 ? 0 : remainingSeconds;
          const needsHours = h > 0;
          const hoursEl = document.getElementById('clockDisplay-hours');
          const hasHours = hoursEl !== null;
          const needsStructureChange = clockDisplay.children.length === 0 || (needsHours && !hasHours) || (!needsHours && hasHours);
          if (needsStructureChange) {
            if (h > 0) {
              displayTimeBlocks(clockDisplay, { hours: h, minutes: m, seconds: s });
            } else {
              displayTimeBlocks(clockDisplay, { minutes: m, seconds: s });
            }
          }
          // Always get fresh references after potential rebuild
          const hoursElAfter = document.getElementById('clockDisplay-hours');
          const minutesElAfter = document.getElementById('clockDisplay-minutes');
          const secondsElAfter = document.getElementById('clockDisplay-seconds');
          if (hoursElAfter) updateRollingText(hoursElAfter, h.toString().padStart(2,'0'));
          if (minutesElAfter) updateRollingText(minutesElAfter, m.toString().padStart(2,'0'));
          if (secondsElAfter) updateRollingText(secondsElAfter, s.toString().padStart(2,'0'));
        clockLabel.innerHTML = "UNTIL NEXT PERIOD";
        timerEl.innerHTML = `Next: <b>${nextPeriod.name}</b><br>${format(nextPeriod.start)} - ${format(nextPeriod.end)}`;
        timerEl.classList.remove('hidden');
      } else {
        displayMessage(clockDisplay, "--:--:--");
        clockLabel.innerHTML = "NO PERIOD SCHEDULED";
        timerEl.classList.add('hidden');
      }
    }
  }
}

function loadThemeOnPage() {
  const theme = localStorage.getItem('theme') || 'purple';
  const gradient = localStorage.getItem('gradient') || 'on';
  document.body.className = `theme-${theme}`;
}

function initApp() {
  checkSetupComplete();
  loadThemeOnPage();
  loadLunchPreferences();
  if (document.getElementById('digitalClock')) {
    updateClock();
    setInterval(updateClock, 1000);
  }
}
initApp();
</script>
</body>
</html>