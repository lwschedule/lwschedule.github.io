<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Install LW Schedule - LW Schedule</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/images/logo.png">
  <link rel="apple-touch-icon" href="/icons/icon-512.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4b2e83">
  <link rel="stylesheet" href="/common.css">
</head>
<body>
  <a href="/" class="backBtn">‚Üê Back to Site</a>
  <div class="appContainer">
    <div class="appHeader">
      <h1>Install LW Schedule</h1>
      <p>Get the best experience with our Progressive Web App</p>
    </div>
    
    <div id="statusMessage" class="statusMessage"></div>
    
    <div class="appButtons">
      <button id="installBtn" class="appBtn installBtn">
        <span id="installBtnText">Install App</span>
        <div id="installBtnSubtext" style="font-size: 0.9em; opacity: 0.8; margin-top: 5px; display: none;"></div>
      </button>
      <button id="continueBtn" class="appBtn">
        Continue on Web
      </button>
    </div>
    
    <div id="installInstructions" class="installInstructions">
      <h3>Installation Instructions</h3>
      <div id="instructionContent"></div>
    </div>
  </div>
  
  <script src="/common.js"></script>
  <script>
    // Check if already in PWA mode and redirect if so
    function checkIfInPWA() {
      // Check if already in standalone mode (PWA)
      if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
        window.location.href = '/setup';
        return true;
      }
      if (window.navigator.standalone === true) {
        window.location.href = '/setup';
        return true;
      }
      return false;
    }
    
    // Universal PWA Installation Logic
    let deferredPrompt;
    let isInstalled = false;
    let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    let isAndroid = /Android/.test(navigator.userAgent);
    let isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    let isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
    let isFirefox = typeof InstallTrigger !== 'undefined';
    
    // Check if app is already installed
    function checkIfInstalled() {
      // Check various installation states
      if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
        return true;
      }
      if (window.navigator.standalone === true) {
        return true;
      }
      // Check for service worker registration
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          if (registrations.length > 0) {
            // Service worker is registered, app might be installed
            updateUIForInstalled();
          }
        });
      }
      return false;
    }
    
    function updateUIForInstalled() {
      isInstalled = true;
      const statusMsg = document.getElementById('statusMessage');
      const installBtn = document.getElementById('installBtn');
      const installBtnText = document.getElementById('installBtnText');
      const continueBtn = document.getElementById('continueBtn');
      
      statusMsg.innerHTML = '‚úÖ App is already installed! You can use it from your home screen.';
      statusMsg.className = 'statusMessage success';
      
      installBtn.style.display = 'none';
      continueBtn.textContent = 'Continue to Setup';
    }
    
    function updateUIForInstallable() {
      const statusMsg = document.getElementById('statusMessage');
      const installBtnSubtext = document.getElementById('installBtnSubtext');
      
      statusMsg.innerHTML = 'üì± Ready to install! Tap the button below to add to your home screen.';
      statusMsg.className = 'statusMessage info';
      installBtnSubtext.style.display = 'block';
      
      if (isChrome) {
        installBtnSubtext.textContent = 'Chrome: Tap the install button that will appear';
      } else if (isIOS) {
        installBtnSubtext.textContent = 'Safari: Tap Share ‚Üí Add to Home Screen';
      } else if (isAndroid && !isChrome) {
        installBtnSubtext.textContent = 'Android: Follow the on-screen instructions';
      } else if (isFirefox) {
        installBtnSubtext.textContent = 'Firefox: Manual installation instructions will be shown';
      } else {
        installBtnSubtext.textContent = 'Your browser: Follow the instructions below';
      }
    }
    
    function updateUIForNotInstallable() {
      const statusMsg = document.getElementById('statusMessage');
      const installBtnText = document.getElementById('installBtnText');
      
      statusMsg.innerHTML = '‚ö†Ô∏è Your browser may not support PWA installation. See instructions below.';
      statusMsg.className = 'statusMessage warning';
      installBtnText.textContent = 'Show Installation Guide';
    }
    
    function showInstallationInstructions() {
      const instructions = document.getElementById('installInstructions');
      const content = document.getElementById('instructionContent');
      instructions.style.display = 'block';
      
      if (isChrome) {
        content.innerHTML = `
          <div class="instructionStep">
            <strong>Chrome/Edge:</strong>
            <p>1. Tap the <span style="color:#4285f4">install</span> button that appears in the address bar</p>
            <p>2. Or tap the three dots menu ‚Üí "Install ${document.title}"</p>
            <p>3. The app will be added to your home screen</p>
          </div>
        `;
      } else if (isIOS) {
        content.innerHTML = `
          <div class="instructionStep">
            <strong>Safari on iPhone/iPad:</strong>
            <p>1. Tap the <span style="color:#007aff">Share</span> button (box with arrow)</p>
            <p>2. Scroll down and tap "Add to Home Screen"</p>
            <p>3. Tap "Add" in the top right corner</p>
            <p>4. Find the app on your home screen!</p>
          </div>
          <div class="instructionStep">
            <strong>Note:</strong> iOS Safari doesn't support full PWA features, but you can still add it to your home screen for easy access.
          </div>
        `;
      } else if (isAndroid && !isChrome) {
        content.innerHTML = `
          <div class="instructionStep">
            <strong>Android Browser:</strong>
            <p>1. Tap the menu button (three dots or lines)</p>
            <p>2. Look for "Add to Home Screen" or "Install App"</p>
            <p>3. Follow the on-screen instructions</p>
          </div>
        `;
      } else if (isFirefox) {
        content.innerHTML = `
          <div class="instructionStep">
            <strong>Firefox:</strong>
            <p>Firefox has limited PWA support. You can:</p>
            <p>1. Bookmark this page for quick access</p>
            <p>2. Use the "Add to Home Screen" option if available</p>
            <p>3. Consider using Chrome/Edge for full PWA features</p>
          </div>
        `;
      } else {
        content.innerHTML = `
          <div class="instructionStep">
            <strong>General Instructions:</strong>
            <p>1. Look for an "Install" or "Add to Home Screen" option in your browser menu</p>
            <p>2. This is usually found in the three-dot menu or share button</p>
            <p>3. Follow your browser's specific instructions</p>
          </div>
          <div class="instructionStep">
            <strong>Benefits of installing:</strong>
            <p>‚Ä¢ Works offline</p>
            <p>‚Ä¢ Faster loading</p>
            <p>‚Ä¢ Home screen icon</p>
            <p>‚Ä¢ Full screen experience</p>
          </div>
        `;
      }
    }
    
    // Event Listeners
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      deferredPrompt = e;
      updateUIForInstallable();
    });
    
    window.addEventListener('appinstalled', (evt) => {
      updateUIForInstalled();
    });
    
    document.getElementById('installBtn').addEventListener('click', async () => {
      if (isInstalled) {
        // Already installed, go to setup
        window.location.href = '/setup';
        return;
      }
      
      if (deferredPrompt) {
        // Chrome/Edge installation
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          updateUIForInstalled();
        }
        deferredPrompt = null;
      } else {
        // Show manual instructions
        showInstallationInstructions();
        updateUIForNotInstallable();
      }
    });
    
    document.getElementById('continueBtn').addEventListener('click', () => {
      // Always go to setup, regardless of installation status
      window.location.href = '/setup';
    });
    
    // Initialize
    window.addEventListener('load', () => {
      if (checkIfInstalled()) {
        updateUIForInstalled();
      } else {
        updateUIForInstallable();
      }
    });
  </script>
</body>
</html>