<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Install LW Schedule - LW Schedule</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/images/logo.png">
  <link rel="apple-touch-icon" href="/icons/icon-512.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4b2e83">
  <link rel="stylesheet" href="/common.css">
  <style>
    .pageContainer { max-width: 650px; margin: 0 auto; padding: 20px 0 20px 0; animation: fadeInUp 0.6s ease-out; }
    .setup-section { background: #1f1f1f; border-radius: 12px; padding: 20px; margin-bottom: 30px; animation: fadeInUp 0.6s ease-out backwards; }
    .setup-section:nth-of-type(1) { animation-delay: 0.1s; }
    .setup-section h3 { margin-top: 0; margin-bottom: 15px; color: white; text-align: left; }
    .setup-description { opacity: 0.8; font-size: 0.9em; margin-bottom: 20px; text-align: center; }
    .appButtons { display: grid; grid-template-columns: 1fr; gap: 20px; margin: 40px 0; }
    .appBtn { background: var(--card-dark); color: var(--text-light); border: 2px solid var(--primary-light); padding: 20px; border-radius: 12px; cursor: pointer; transition: all 0.3s; font-size: 1.2em; font-weight: 700; text-align: center; box-shadow: var(--glow); }
    .appBtn:hover { background: var(--primary-light); color: white; transform: scale(1.05); }
    .appBtn.installBtn { background: linear-gradient(135deg, var(--primary), var(--primary-light), var(--primary)) !important; background-size: 200% 200% !important; animation: gradientShift5 8s ease infinite !important; }
    .appBtn.installBtn:hover { box-shadow: 0 0 30px rgba(107, 76, 183, 0.8); }
    @media (max-width: 600px) {
      .appButtons { gap: 15px; }
      .appBtn { padding: 15px; font-size: 1.1em; }
    }
  </style>
</head>
<body>
  <div class="pageContainer">
    <h2>Install LW Schedule</h2>
    <div class="setup-section">
      <div class="appButtons">
        <button id="installBtn" class="appBtn installBtn">
          Install App
        </button>
        <button id="continueBtn" class="appBtn">
          Continue on Web
        </button>
      </div>
    </div>
  </div>
  
  <script src="/common.js"></script>
  <script>
    // Check if already in PWA mode and redirect if so
    function checkIfInPWA() {
      // Check if already in standalone mode (PWA)
      if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
        window.location.href = '/setup';
        return true;
      }
      if (window.navigator.standalone === true) {
        window.location.href = '/setup';
        return true;
      }
      return false;
    }
    
    // PWA Installation Logic
    let deferredPrompt;
    
    // Check if app is already installed
    function checkIfInstalled() {
      // Check various installation states
      if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
        return true;
      }
      if (window.navigator.standalone === true) {
        return true;
      }
      return false;
    }
    
    function updateUIForInstalled() {
      const installBtn = document.getElementById('installBtn');
      const continueBtn = document.getElementById('continueBtn');
      
      installBtn.style.display = 'none';
      continueBtn.textContent = 'Continue to Setup';
    }
    
    // Event Listeners
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      deferredPrompt = e;
    });
    
    window.addEventListener('appinstalled', (evt) => {
      updateUIForInstalled();
    });
    
    document.getElementById('installBtn').addEventListener('click', async () => {
      if (checkIfInstalled()) {
        // Already installed, go to setup
        window.location.href = '/setup';
        return;
      }
      
      if (deferredPrompt) {
        // Chrome/Edge installation
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          updateUIForInstalled();
        }
        deferredPrompt = null;
      } else {
        // Not installable, go to setup
        window.location.href = '/setup';
      }
    });
    
    document.getElementById('continueBtn').addEventListener('click', () => {
      // Always go to setup, regardless of installation status
      window.location.href = '/setup';
    });
    
    // Initialize
    window.addEventListener('load', () => {
      if (checkIfInPWA()) {
        return;
      }
      
      if (checkIfInstalled()) {
        updateUIForInstalled();
      }
    });
  </script>
</body>
</html>